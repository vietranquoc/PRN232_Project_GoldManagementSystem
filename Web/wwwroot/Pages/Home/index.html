<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoldTrack</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="../../css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div id="header-include"></div>

    <!-- Hero Section -->
    <section class="hero-section">
        <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <img src="/images/banner1.jpg" class="d-block w-100" alt="Banner 1">
                </div>
                <div class="carousel-item">
                    <img src="/images/banner2.jpg" class="d-block w-100" alt="Banner 2">
                </div>
                <div class="carousel-item">
                    <img src="/images/banner3.jpg" class="d-block w-100" alt="Banner 3">
                </div>
                <div class="carousel-item">
                    <img src="/images/banner4.jpg" class="d-block w-100" alt="Banner 4">
                </div>
                <div class="carousel-item">
                    <img src="/images/banner5.jpg" class="d-block w-100" alt="Banner 5">
                </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
            </button>
        </div>
        <div class="container hero-content text-center text-white py-5">
            <p class="lead mt-3">Khám phá thế giới trang sức cao cấp tại GoldTrack</p>
            <a href="#" class="btn btn-light me-2 mt-3">Xem giá vàng hôm nay</a>
            <a href="#" class="btn btn-warning mt-3">Mua ngay</a>
        </div>
    </section>

    <!-- Gold Price Section -->
    <section class="gold-price-section py-5">
        <div class="container">
            <h2 class="text-center mb-4"><i class="fas fa-coins text-warning me-2"></i>Giá Vàng Hôm Nay</h2>
            <div class="table-responsive">
                <table class="table table-bordered text-center align-middle shadow-sm">
                    <thead class="table-warning">
                        <tr>
                            <th>Loại vàng</th>
                            <th>Mua vào</th>
                            <th>Bán ra</th>
                        </tr>
                    </thead>
                    <tbody id="gold-price-tbody">
                        <tr><td colspan="3"><span class="spinner-border spinner-border-sm text-warning"></span> Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Featured Products -->
    <section class="featured-products py-5">
        <div class="container">
            <h2 class="text-center mb-4"><i class="fas fa-star text-warning me-2"></i>Sản phẩm Nổi bật</h2>
            <div id="featured-products-row" class="row">
                <div class="text-center text-muted w-100" id="featured-products-loading">
                    <span class="spinner-border spinner-border-sm text-warning"></span> Đang tải...
                </div>
            </div>
        </div>
    </section>

    <!-- News Section -->
    <section class="news-section py-5 bg-light">
        <div class="container">
            <h2 class="text-center mb-4">Tin tức & Blog</h2>
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <img src="https://via.placeholder.com/300x200" class="card-img-top" alt="Tin tức">
                        <div class="card-body">
                            <h5 class="card-title">Giá vàng tăng mạnh trong tuần qua</h5>
                            <p class="card-text">Cập nhật ngày 01/07/2025</p>
                            <a href="#" class="btn btn-outline-primary">Đọc thêm</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <img src="https://via.placeholder.com/300x200" class="card-img-top" alt="Tin tức">
                        <div class="card-body">
                            <h5 class="card-title">Tư vấn đầu tư vàng hiệu quả</h5>
                            <p class="card-text">Cập nhật ngày 01/07/2025</p>
                            <a href="#" class="btn btn-outline-primary">Đọc thêm</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <img src="https://via.placeholder.com/300x200" class="card-img-top" alt="Tin tức">
                        <div class="card-body">
                            <h5 class="card-title">Ưu đãi đặc biệt tháng 7</h5>
                            <p class="card-text">Cập nhật ngày 01/07/2025</p>
                            <a href="#" class="btn btn-outline-primary">Đọc thêm</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Chatbot Button -->
    <button id="chatbot-button" class="btn btn-warning rounded-circle shadow-lg"
            style="position: fixed; bottom: 20px; right: 20px; z-index: 1050;">
        <i class="fas fa-comment-dots"></i>
    </button>

    <!-- Chatbot Box (Initially Hidden) -->
    <div id="chatbot-box" class="card shadow-lg"
         style="position: fixed; bottom: 80px; right: 20px; width: 400px; display: none; z-index: 1050;">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <span><i class="fas fa-robot me-2"></i>GoldBot</span>
            <button type="button" class="btn-close" id="close-chatbot"></button>
        </div>
        <div class="card-body p-2">
            <div id="chat-log" style="max-height: 300px; overflow-y: auto;"></div>
            <textarea id="chat-input" class="form-control mt-2" rows="1" placeholder="Nhập câu hỏi..." style="resize: none; overflow-y: hidden;"></textarea>
        </div>
    </div>

    <div id="footer-include"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../../js/main.js"></script>
    <script>
        loadHeaderFooter();
        // Các script riêng khác giữ nguyên
        const chatbotButton = document.getElementById('chatbot-button');
        const chatbotBox = document.getElementById('chatbot-box');
        const closeChatbot = document.getElementById('close-chatbot');

        chatbotButton.addEventListener('click', () => {
            chatbotBox.style.display = 'block';
            chatbotButton.style.display = 'none';
        });

        closeChatbot.addEventListener('click', () => {
            chatbotBox.style.display = 'none';
            chatbotButton.style.display = 'block';
        });
        const input = document.getElementById('chat-input');

        input.addEventListener('input', function () {
            this.style.height = 'auto'; 
            this.style.height = this.scrollHeight + 'px'; 
        });

        const log = document.getElementById('chat-log');

        input.addEventListener('keydown', async function (e) {
            if (e.key === 'Enter' && input.value.trim() !== '') {
                const userMsg = input.value.trim();
                input.value = '';
                log.innerHTML += `<div><strong>You:</strong> ${userMsg}</div>`;
                log.scrollTop = log.scrollHeight; 

                try {
                    const response = await fetch('https://localhost:5000/api/chatbot/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userMsg })
                    });

                    if (!response.ok) {
                        const errText = await response.text();
                        console.error("Server error:", errText);
                        log.innerHTML += `<div><strong>Advisor:</strong> Sorry, something went wrong.</div>`;
                        log.scrollTop = log.scrollHeight; 
                        return;
                    }

                    const contentType = response.headers.get('content-type') || "";
                    if (contentType.includes("application/json")) {
                        const data = await response.json();
                        log.innerHTML += `<div><strong>Advisor:</strong> ${data.reply}</div>`;
                    } else {
                        const raw = await response.text();
                        console.warn("Not JSON:", raw);
                        log.innerHTML += `<div><strong>Advisor:</strong> Unexpected response format.</div>`;
                    }

                } catch (err) {
                    console.error("Fetch failed:", err);
                    log.innerHTML += `<div><strong>Advisor:</strong> Failed to reach server.</div>`;
                }

                log.scrollTop = log.scrollHeight; 
            }
        });

        // Search functionality
        function checkInputSearchEnter(event) {
            if (event.key === 'Enter') {
                const query = event.target.value;
                window.location.href = `/search?q=${encodeURIComponent(query)}`;
            }
        }
        let goldTypeMap = {};
        function loadGoldTypes() {
            $.ajax({
                url: 'https://localhost:5000/api/GoldType',
                method: 'GET',
                success: function (data) {
                    goldTypeMap = {};
                    data.forEach(function (gt) {
                        goldTypeMap[gt.id] = gt.name;
                    });
                },
                error: function () {
                    goldTypeMap = {};
                }
            });
        }
        function fetchGoldPrices() {
            const tbody = $('#gold-price-tbody');
            tbody.html('<tr><td colspan="3"><span class="spinner-border spinner-border-sm text-warning"></span> Đang tải...</td></tr>');
            $.ajax({
                url: 'https://localhost:5000/api/GoldPrice',
                method: 'GET',
                success: function (data) {
                    if (!data || data.length === 0) {
                        tbody.html('<tr><td colspan="3">Không có dữ liệu</td></tr>');
                        return;
                    }
                    let html = '';
                    data.forEach(function (row) {
                        html += `<tr>
                                                            <td><b>${goldTypeMap[row.goldTypeId] || 'Không xác định'}</b></td>
                                                            <td class="text-success fw-bold">${Number(row.buyPrice).toLocaleString('vi-VN')} <span class="text-muted">VNĐ</span></td>
                                                            <td class="text-danger fw-bold">${Number(row.sellPrice).toLocaleString('vi-VN')} <span class="text-muted">VNĐ</span></td>
                                                        </tr>`;
                    });
                    tbody.html(html);
                },
                error: function (xhr) {
                    tbody.html(`<tr><td colspan="3" class="text-danger">Lỗi: ${xhr.responseText || 'Không thể lấy dữ liệu'}</td></tr>`);
                }
            });
        }
        $(document).ready(function () {
            loadGoldTypes();
            setTimeout(fetchGoldPrices, 300); // Đảm bảo goldTypeMap đã load
            fetchFeaturedProducts();
        });
        // Sản phẩm nổi bật
        function fetchFeaturedProducts() {
            const row = $('#featured-products-row');
            row.html('<div class="text-center text-muted w-100" id="featured-products-loading"><span class="spinner-border spinner-border-sm text-warning"></span> Đang tải...</div>');
            $.ajax({
                url: 'https://localhost:5000/api/Product',
                method: 'GET',
                success: function (data) {
                    if (!data || data.length === 0) {
                        row.html('<div class="text-center text-muted w-100">Không có sản phẩm nổi bật</div>');
                        return;
                    }
                    const featured = data.slice(0, 4);
                    let html = '';
                    featured.forEach(function (prod) {
                        html += `
                                                            <div class="col-md-3 col-sm-6 mb-4">
                                                                <div class="card h-100 shadow-sm">
                                                                    <img src="${(prod.images && prod.images.length > 0) ? prod.images[0].imageUrl : 'https://via.placeholder.com/200x200'}" class="card-img-top" alt="${prod.name}">
                                                                    <div class="card-body">
                                                                        <h5 class="card-title">${prod.name}</h5>
                                                                        <p class="card-text text-warning fw-bold">${Number(prod.price).toLocaleString('vi-VN')} VNĐ</p>
                                                                        <a href="#" class="btn btn-outline-warning">Xem chi tiết</a>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        `;
                    });
                    row.html(html);
                },
                error: function (xhr) {
                    row.html(`<div class="text-center text-danger w-100">Lỗi: ${xhr.responseText || 'Không thể lấy sản phẩm'}</div>`);
                }
            });
        }
    </script>
</body>
</html>