<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh toán | GoldTrack</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="../../css/checkout.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body style="background:#faf7f7;">
    
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-7 col-md-12 mb-4">
                <div class="checkout-title">
                    <i class="fas fa-gem me-2"></i>GoldTrack
                </div>
                <div class="checkout-breadcrumb"><a href="/Pages/Product/cart.html" style="text-decoration: none; color: #FFD700;">Về giỏ hàng</a> &gt; Thông tin giao hàng</div>
                <div class="card checkout-card mb-4">
                    <div class="card-body">
                        <form id="checkout-form">
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <input type="text" class="form-control checkout-input" placeholder="Họ và tên" name="fullname" required>
                                </div>
                                <div class="col-md-6">
                                    <input type="email" class="form-control checkout-input" placeholder="Email nhận thông tin đơn hàng" name="email">
                                </div>
                                <div class="col-md-6">
                                    <input type="tel" class="form-control checkout-input" placeholder="Số điện thoại (*)" name="phone" required>
                                </div>
                            </div>
                            <div class="d-flex mb-3 gap-2">
                                <button type="button" class="btn btn-outline-dark flex-fill" id="btn-delivery">Giao hàng tận nơi</button>
                                <button type="button" class="btn btn-outline-dark flex-fill" id="btn-pickup">Nhận tại cửa hàng</button>
                            </div>
                            <div class="form-text mb-3">(Miễn phí giao hàng tận nơi)</div>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <select class="form-select checkout-select" name="province" required>
                                        <option value="">Tỉnh / Thành phố</option>
                                        <option value="01">Hà Nội</option>
                                        <option value="02">Hà Giang</option>
                                        <option value="04">Cao Bằng</option>
                                        <option value="06">Bắc Kạn</option>
                                        <option value="08">Tuyên Quang</option>
                                        <option value="10">Lào Cai</option>
                                        <option value="11">Điện Biên</option>
                                        <option value="12">Lai Châu</option>
                                        <option value="14">Sơn La</option>
                                        <option value="15">Yên Bái</option>
                                        <option value="17">Hoà Bình</option>
                                        <option value="19">Thái Nguyên</option>
                                        <option value="20">Lạng Sơn</option>
                                        <option value="22">Quảng Ninh</option>
                                        <option value="24">Bắc Giang</option>
                                        <option value="25">Phú Thọ</option>
                                        <option value="26">Vĩnh Phúc</option>
                                        <option value="27">Bắc Ninh</option>
                                        <option value="30">Hải Dương</option>
                                        <option value="31">Hải Phòng</option>
                                        <option value="33">Hưng Yên</option>
                                        <option value="34">Thái Bình</option>
                                        <option value="35">Hà Nam</option>
                                        <option value="36">Nam Định</option>
                                        <option value="37">Ninh Bình</option>
                                        <option value="38">Thanh Hóa</option>
                                        <option value="40">Nghệ An</option>
                                        <option value="42">Hà Tĩnh</option>
                                        <option value="44">Quảng Bình</option>
                                        <option value="45">Quảng Trị</option>
                                        <option value="46">Thừa Thiên Huế</option>
                                        <option value="48">Đà Nẵng</option>
                                        <option value="49">Quảng Nam</option>
                                        <option value="51">Quảng Ngãi</option>
                                        <option value="52">Bình Định</option>
                                        <option value="54">Phú Yên</option>
                                        <option value="56">Khánh Hòa</option>
                                        <option value="58">Ninh Thuận</option>
                                        <option value="60">Bình Thuận</option>
                                        <option value="62">Kon Tum</option>
                                        <option value="64">Gia Lai</option>
                                        <option value="66">Đắk Lắk</option>
                                        <option value="67">Đắk Nông</option>
                                        <option value="68">Lâm Đồng</option>
                                        <option value="70">Bình Phước</option>
                                        <option value="72">Tây Ninh</option>
                                        <option value="74">Bình Dương</option>
                                        <option value="75">Đồng Nai</option>
                                        <option value="77">Bà Rịa - Vũng Tàu</option>
                                        <option value="79">Hồ Chí Minh</option>
                                        <option value="80">Long An</option>
                                        <option value="82">Tiền Giang</option>
                                        <option value="83">Bến Tre</option>
                                        <option value="84">Trà Vinh</option>
                                        <option value="86">Vĩnh Long</option>
                                        <option value="87">Đồng Tháp</option>
                                        <option value="89">An Giang</option>
                                        <option value="91">Kiên Giang</option>
                                        <option value="92">Cần Thơ</option>
                                        <option value="93">Hậu Giang</option>
                                        <option value="94">Sóc Trăng</option>
                                        <option value="95">Bạc Liêu</option>
                                        <option value="96">Cà Mau</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <select class="form-select checkout-select" name="district" required>
                                        <option value="">Quận / Huyện</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <input type="text" class="form-control checkout-input" placeholder="Địa chỉ" name="address" required>
                            </div>
                            <div class="mb-3">
                                <div class="checkout-label">Phương thức vận chuyển</div>
                                <div class="card p-3 mb-2" style="border-radius:8px; border:1px solid #f3eaea;">
                                    <div class="form-check">
                                        <input class="form-check-input checkout-radio" type="radio" name="shipping" id="shipping1" checked>
                                        <label class="form-check-label" for="shipping1">
                                            Miễn phí giao hàng tiêu chuẩn <span class="text-muted" style="font-size:0.95em;">(3-5 ngày hoặc thời gian nhận hàng dự kiến)</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="card p-3" style="border-radius:8px; border:1px solid #f3eaea;">
                                    <div class="form-check">
                                        <input class="form-check-input checkout-radio" type="radio" name="shipping" id="shipping2">
                                        <label class="form-check-label" for="shipping2">
                                            Giao hàng hỏa tốc trong 2 giờ <span class="text-muted" style="font-size:0.95em;">(100.000đ)</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="checkout-label">Phương thức thanh toán</div>
                                <div class="card p-3 mb-2" style="border-radius:8px; border:1px solid #f3eaea;">
                                    <div class="form-check">
                                        <input class="form-check-input checkout-radio" type="radio" name="payment" id="pay-bank" checked>
                                        <label class="form-check-label" for="pay-bank">
                                            <i class="fas fa-money-check-alt me-1"></i> Chuyển khoản ngân hàng qua mã QR
                                        </label>
                                    </div>
                                </div>
                                <div class="card p-3" style="border-radius:8px; border:1px solid #f3eaea;">
                                    <div class="form-check">
                                        <input class="form-check-input checkout-radio" type="radio" name="payment" id="pay-cod">
                                        <label class="form-check-label" for="pay-cod">
                                            <i class="fas fa-wallet me-1"></i> Thanh toán khi nhận hàng
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <textarea class="form-control checkout-textarea" rows="2" placeholder="Ghi chú đơn hàng" name="note"></textarea>
                            </div>
                            <div class="checkout-btn-row d-flex justify-content-between align-items-center">
                                <a href="/Pages/Product/cart.html" class="checkout-link" style="text-decoration: none;">Về giỏ hàng</a>
                                <button type="submit" class="btn btn-danger" style="font-weight:600;">HOÀN TẤT ĐƠN HÀNG</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-5 col-md-10">
                <div class="card checkout-card">
                    <div class="card-body">
                        <div class="checkout-summary-title">Tóm tắt đơn hàng</div>
                        <div id="checkout-cart-list">
                            
                        </div>
                        <div class="mb-2 mt-3 d-flex justify-content-between">
                            <span>Tổng tiền hàng</span>
                            <span id="summary-total">0đ</span>
                        </div>
                        <div class="mb-2 d-flex justify-content-between">
                            <span>Tổng cộng Voucher giảm giá</span>
                            <span id="summary-voucher">- 0đ</span>
                        </div>
                        <div class="mb-2 d-flex justify-content-between">
                            <span>Tổng tiền phí vận chuyển</span>
                            <span id="summary-shipping">Miễn phí</span>
                        </div>
                        <div class="mb-2 d-flex justify-content-between align-items-center" style="font-size:1.1rem;">
                            <span style="font-weight:600;">Tổng thanh toán</span>
                            <span id="summary-grand" class="checkout-summary-total">0đ</span>
                        </div>
                        <input type="text" class="form-control checkout-input mt-3" placeholder="Mã giảm giá">
                        <button class="btn btn-light mt-2 mb-3" style="color:#fff;background:#FFD700;">Sử dụng</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../../js/main.js"></script>
    <script>
        
        let deliveryMethod = "delivery"; 
        let checkoutTotal = 0;
        
        function getToken() {
            return localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken');
        }

        function updateShippingFeeDisplay() {
            let shippingFee = 0;
            if ($('[name="shipping"]:checked').attr('id') === 'shipping2') {
                $('#summary-shipping').text('100.000đ');
                shippingFee = 100000;
            } else {
                $('#summary-shipping').text('Miễn phí');
            }
            
            const grandTotal = checkoutTotal + shippingFee;
            $('#summary-grand').text(Number(grandTotal).toLocaleString('vi-VN') + 'đ');
        }
        
        function loadCheckoutCart() {
            const token = getToken();
            if (!token) {
                $('#checkout-cart-list').html('<div class="alert alert-warning">Bạn cần đăng nhập để thanh toán.</div>');
                $('#summary-total, #summary-grand').text('0đ');
                checkoutTotal = 0;
                updateShippingFeeDisplay();
                return;
            }
            $.ajax({
                url: 'https://localhost:5000/api/cart',
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token },
                success: function(data) {
                    if (!data.items || data.items.length === 0) {
                        $('#checkout-cart-list').html('<div class="alert alert-info">Giỏ hàng của bạn đang trống.</div>');
                        $('#summary-total, #summary-grand').text('0đ');
                        checkoutTotal = 0;
                        updateShippingFeeDisplay();
                        return;
                    }
                    let html = '';
                    let total = 0;
                    data.items.forEach(item => {
                        const thanhTien = item.price * item.quantity;
                        total += thanhTien;
                        html += `
                            <div class="d-flex align-items-center mb-2">
                                <img src="${item.productImage || 'https://via.placeholder.com/60'}" alt="" style="width:60px;height:60px;object-fit:cover;border-radius:6px;margin-right:10px;">
                                <div style="flex:1">
                                    <div style="font-weight:500">${item.productName || 'Sản phẩm #' + item.productId}</div>
                                    <div style="font-size:0.9em;color:#888">SL: ${item.quantity} x ${Number(item.price).toLocaleString('vi-VN')}đ</div>
                                </div>
                                <div style="font-weight:500">${Number(thanhTien).toLocaleString('vi-VN')}đ</div>
                            </div>
                        `;
                    });
                    $('#checkout-cart-list').html(html);
                    $('#summary-total').text(Number(total).toLocaleString('vi-VN') + 'đ');
                    checkoutTotal = total;
                    updateShippingFeeDisplay();
                },
                error: function() {
                    $('#checkout-cart-list').html('<div class="alert alert-danger">Không thể tải giỏ hàng.</div>');
                    $('#summary-total, #summary-grand').text('0đ');
                    checkoutTotal = 0;
                    updateShippingFeeDisplay();
                }
            });
        }
        
        $(document).ready(function() {
            loadCheckoutCart();
            const districtsByProvince = {
                "01": [
                    "Ba Đình", "Hoàn Kiếm", "Tây Hồ", "Long Biên", "Cầu Giấy", "Đống Đa", "Hai Bà Trưng", "Hoàng Mai", "Thanh Xuân", "Nam Từ Liêm", "Bắc Từ Liêm", "Hà Đông", "Sơn Tây", "Ba Vì", "Chương Mỹ", "Đan Phượng", "Đông Anh", "Gia Lâm", "Hoài Đức", "Mê Linh", "Mỹ Đức", "Phú Xuyên", "Phúc Thọ", "Quốc Oai", "Sóc Sơn", "Thạch Thất", "Thanh Oai", "Thanh Trì", "Thường Tín", "Ứng Hòa"
                ],
                "79": [
                    "Quận 1", "Quận 3", "Quận 4", "Quận 5", "Quận 6", "Quận 7", "Quận 8", "Quận 10", "Quận 11", "Quận 12", "Bình Thạnh", "Gò Vấp", "Phú Nhuận", "Tân Bình", "Tân Phú", "Thủ Đức", "Bình Tân", "Bình Chánh", "Cần Giờ", "Củ Chi", "Hóc Môn", "Nhà Bè"
                ]
            };
            $('[name="province"]').on('change', function() {
                const provinceCode = $(this).val();
                const districts = districtsByProvince[provinceCode] || [];
                const $districtSelect = $('[name="district"]');
                $districtSelect.empty();
                $districtSelect.append('<option value="">Quận / Huyện</option>');
                districts.forEach(function(district) {
                    $districtSelect.append('<option value="' + district + '">' + district + '</option>');
                });
            });

            // Sự kiện chọn phương thức giao hàng
            $('#btn-delivery').on('click', function() {
                deliveryMethod = "delivery";
                $(this).addClass('active');
                $('#btn-pickup').removeClass('active');
                $('[name="province"], [name="district"], [name="address"]').prop('disabled', false);
                $('[name="shipping"]').prop('disabled', false);
            });
            $('#btn-pickup').on('click', function() {
                deliveryMethod = "pickup";
                $(this).addClass('active');
                $('#btn-delivery').removeClass('active');
                $('[name="province"], [name="district"], [name="address"]').prop('disabled', true);
                $('[name="shipping"]').prop('disabled', true);
            });

            // Sự kiện thay đổi phương thức vận chuyển
            $('[name="shipping"]').on('change', updateShippingFeeDisplay);
            updateShippingFeeDisplay();
        });
        
        $('#checkout-form').on('submit', function(e) {
            e.preventDefault();
            const token = getToken();
            if (!token) {
                Swal.fire('Bạn cần đăng nhập để đặt hàng!', '', 'warning');
                return;
            }
            
            const formData = {
                receiverName: $('[name="fullname"]').val(),
                receiverPhone: $('[name="phone"]').val(),
                receiverEmail: $('[name="email"]').val(),
                province: $('[name="province"]').val(),
                district: $('[name="district"]').val(),
                address: $('[name="address"]').val(),
                note: $('[name="note"]').val(),
                deliveryMethod: deliveryMethod,
                shippingMethod: $('[name="shipping"]:checked').attr('id'),
                paymentMethod: $('[name="payment"]:checked').attr('id') 
            };
            
            Swal.fire({
                title: 'Xác nhận đặt hàng?',
                text: 'Bạn có chắc chắn muốn hoàn tất đơn hàng?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Đặt hàng',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: 'https://localhost:5000/api/cart/checkout',
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + token },
                        contentType: 'application/json',
                        data: JSON.stringify(formData),
                        success: function(response) {
                            if (formData.paymentMethod === 'pay-cod') {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Cảm ơn bạn đã đặt hàng!',
                                    text: 'Đơn hàng của bạn đã được ghi nhận. Chúng tôi sẽ liên hệ và giao hàng sớm nhất.',
                                    confirmButtonText: 'Về trang chủ'
                                }).then(() => {
                                    window.location.href = '/';
                                });
                            } else if (formData.paymentMethod === 'pay-bank') {
                                // Tạo thanh toán VNPAY
                                $.ajax({
                                    url: 'https://localhost:5000/api/payment/create-vnpay-payment',
                                    method: 'POST',
                                    headers: { 'Authorization': 'Bearer ' + token },
                                    contentType: 'application/json',
                                    data: JSON.stringify({
                                        orderId: response.orderId,
                                        amount: response.totalAmount,
                                        orderInfo: 'Thanh toan don hang GoldTrack #' + response.orderId
                                    }),
                                    success: function(vnpayResponse) {
                                        if (vnpayResponse.isSuccess) {
                                            Swal.fire({
                                                icon: 'info',
                                                title: 'Chuyển hướng đến VNPAY',
                                                text: 'Bạn sẽ được chuyển hướng đến trang thanh toán VNPAY trong giây lát...',
                                                timer: 2000,
                                                showConfirmButton: false
                                            }).then(() => {
                                                window.location.href = vnpayResponse.paymentUrl;
                                            });
                                        } else {
                                            Swal.fire('Lỗi', 'Không thể tạo thanh toán VNPAY', 'error');
                                        }
                                    },
                                    error: function(xhr) {
                                        Swal.fire('Lỗi', xhr.responseJSON?.message || 'Không thể tạo thanh toán VNPAY', 'error');
                                    }
                                });
                            } else {
                                Swal.fire('Thành công!', response.message, 'success').then(() => {
                                    window.location.href = '/';
                                });
                            }
                        },
                        error: function(xhr) {
                            Swal.fire('Lỗi', xhr.responseText || 'Đặt hàng thất bại', 'error');
                        }
                    });
                }
            });
        });
        </script>
</body>
</html> 